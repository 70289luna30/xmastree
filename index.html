<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åå­¸é™¢ï½œAI è–èª•æ¨¹äº’å‹•ï¼ˆè¦–è¦ºé‚„åŸ RWD ç‰ˆï¼‰</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Corinthia:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
    #canvas-container { position: fixed; inset: 0; z-index: 1; }

    /* æ”å½±æ©Ÿé è¦½ - RWD èª¿æ•´ */
    #video-preview {
      position: fixed; left: 16px; bottom: 16px;
      width: clamp(100px, 25vw, 160px); height: auto;
      aspect-ratio: 4/3;
      border-radius: 14px;
      transform: scaleX(-1);
      border: 2px solid rgba(255,255,255,0.18);
      z-index: 10;
      object-fit: cover;
      background: #000;
      opacity: 0.55;
    }

    /* å·¨å¤§æ¨™é¡Œ - RWD å„ªåŒ– */
    #big-title {
      position: fixed;
      top: 2vh; left: 50%;
      transform: translateX(-50%);
      z-index: 13;
      pointer-events: none;
      white-space: nowrap;
      font-family: "Corinthia", cursive;
      font-weight: 700;
      color: #ffffff;
      font-size: clamp(60px, 15vw, 140px);
      line-height: 1;
      text-shadow: 0 0 10px rgba(255, 60, 60, 0.9), 0 0 10px rgba(255, 215, 0, 0.85);
    }

    #text-layer {
      position: fixed;
      top: clamp(100px, 20vh, 140px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 12;
      width: 90vw;
      text-align: center;
      pointer-events: none;
      color: rgba(255,255,255,0.92);
    }

    /* æ”¶åˆå¼ UI æ§åˆ¶é¢æ¿ */
    #ui-panel {
      position: fixed; top: 16px; right: 16px;
      width: 280px; padding: 16px;
      background: rgba(20,20,35,0.85);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff; z-index: 100;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* æ‰‹æ©Ÿç«¯é è¨­æ”¶èµ· */
    @media (max-width: 600px) {
      #ui-panel { transform: translateX(120%); opacity: 0; }
      #ui-panel.show { transform: translateX(0); opacity: 1; }
    }

    /* é½’è¼ª/æ§åˆ¶æŒ‰éˆ• */
    #ui-toggle {
      position: fixed; top: 16px; right: 16px;
      width: 44px; height: 44px;
      background: rgba(34,255,136,0.9);
      border-radius: 12px; display: none; /* åƒ…æ‰‹æ©Ÿé¡¯ç¤º */
      align-items: center; justify-content: center;
      z-index: 101; cursor: pointer; font-size: 20px;
    }
    @media (max-width: 600px) { #ui-toggle { display: flex; } }

    /* åŸæœ‰æ¨£å¼ä¿æŒ */
    .color-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
    .cbtn { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; }
    .toggle-row { display:flex; align-items:center; justify-content:space-between; margin-top: 10px; }
    .switch { width: 44px; height: 24px; background: rgba(255,255,255,0.14); border-radius: 999px; position: relative; cursor: pointer; }
    .knob { width: 18px; height: 18px; border-radius: 50%; background: #fff; position: absolute; top: 3px; left: 3px; transition: 0.2s; }
    .switch.on .knob { left: 23px; background: #22ff88; }

    #reveal-card {
      position: fixed; left: 50%; top: 55%; transform: translate(-50%, -50%) scale(0.9);
      width: min(85vw, 380px); background: rgba(10,10,18,0.72);
      border-radius: 18px; padding: 12px; z-index: 20; opacity: 0;
      transition: 0.3s ease; backdrop-filter: blur(10px); pointer-events: none;
    }
    #reveal-card.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    #reveal-card img { width: 100%; border-radius: 14px; }

    #status {
      position: fixed; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; color: #fff; z-index: 200;
      background: rgba(0,0,0,0.8); text-align: center; padding: 20px;
    }
    #start-btn { margin-top: 18px; padding: 12px 24px; border-radius: 999px; border: 0; background: #22ff88; font-weight: 800; cursor: pointer; }
    
    .sparkle { position: fixed; width: 40px; height: 40px; background: radial-gradient(circle, #fff, #ffd700, transparent); border-radius: 50%; pointer-events: none; z-index: 999; animation: flash 0.5s forwards; mix-blend-mode: screen; }
    @keyframes flash { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
  </style>
</head>
<body>

  <div id="status">
    <h1>ğŸ„ AI è–èª•æ¨¹äº’å‹•</h1>
    <p>ğŸ‘‹ æ®æ‰‹ç§»å‹• | ğŸ– å¼µé–‹è§£é– | ğŸ‘Œ æåˆé­”æ³•</p>
    <button id="start-btn">âœ¨ é–‹å§‹é«”é©—</button>
  </div>

  <video id="video-preview" playsinline></video>
  <div id="big-title">Merry Christmas</div>
  <div id="text-layer">
    <div class="subline">æ‰‹æŒå¼µé–‹ âœ è§£é–é©šå–œ</div>
  </div>

  <div id="reveal-card">
    <img src="./xmas.jpg" alt="Surprise" />
    <div style="color:#fff; text-align:center; margin-top:10px; font-size:13px;">çµ¦ä½ ä¸€å€‹ä¸ç„¡èŠçš„è–èª•é©šå–œ âœ¨</div>
  </div>

  <audio id="bgm" src="./xmas_song.mp3" loop preload="auto"></audio>

  <div id="ui-toggle">âš™ï¸</div>
  <div id="ui-panel">
    <h2 style="font-size:16px; margin:0;">âœ¨ æ§åˆ¶å°</h2>
    <div class="color-row">
      <div class="cbtn" style="background:#22ff88" data-c="#22ff88"></div>
      <div class="cbtn" style="background:#ff4d4d" data-c="#ff4d4d"></div>
      <div class="cbtn" style="background:#ffd700" data-c="#ffd700"></div>
      <div class="cbtn" style="background:#ffffff" data-c="#ffffff"></div>
    </div>
    <div class="toggle-row">
      <label style="font-size:12px;">æ¼¸å±¤æ¨¡å¼</label>
      <div id="gradSwitch" class="switch on"><div class="knob"></div></div>
    </div>
    <button id="audio-btn" style="width:100%; margin-top:10px; background:rgba(255,255,255,0.1); color:#fff; border:none; padding:8px; border-radius:8px; cursor:pointer;">ğŸ”Š éŸ³æ¨‚æ’­æ”¾ä¸­</button>
    <div id="close-ui" style="text-align:center; color:#22ff88; margin-top:15px; cursor:pointer; font-size:12px; display:none;">é—œé–‰é¸å–®</div>
  </div>

  <div id="canvas-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <script>
    // --- åŸºç¤åˆå§‹åŒ– ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x000000, 35, 120);
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1500);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);
    camera.position.set(0, 3, 52);

    const group = new THREE.Group();
    scene.add(group);
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const keyLight = new THREE.DirectionalLight(0xffffff, 0.8);
    keyLight.position.set(30, 40, 25);
    scene.add(keyLight);

    const isMobile = window.innerWidth < 600;

    // --- ã€è¦–è¦ºé‚„åŸã€‘æ¨¹é«”ç²’å­ ---
    const particleCount = isMobile ? 8000 : 14000;
    const treeGeometry = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    const baseTargets = new Float32Array(particleCount * 3);
    const explodedTargets = new Float32Array(particleCount * 3);

    const H = 36, yMin = -H * 0.55, yMax = H * 0.45, maxR = 15.5;
    function radiusAtY(y) { const t = (y - yMin) / (yMax - yMin); return maxR * (1 - t) * 0.98 + 0.7; }

    const gradFrom = new THREE.Color(0x22ff88), gradTo = new THREE.Color(0xffd700);

    for (let i = 0; i < particleCount; i++) {
      const idx = i * 3;
      const y = yMin + Math.random() * (yMax - yMin);
      const r = radiusAtY(y);
      const t = (y - yMin) / (yMax - yMin);
      const angle = (t * Math.PI * 2 * 10) * 1.15 + (Math.random()-0.5)*0.9;
      const x = Math.cos(angle) * (r + (Math.random()-0.5)*1.6);
      const z = Math.sin(angle) * (r + (Math.random()-0.5)*1.6);

      baseTargets[idx] = x; baseTargets[idx+1] = y; baseTargets[idx+2] = z;
      const dir = new THREE.Vector3(x, y * 0.18, z).normalize();
      const str = 34 + Math.random() * 22;
      explodedTargets[idx] = x + dir.x * str; explodedTargets[idx+1] = y + dir.y * str; explodedTargets[idx+2] = z + dir.z * str;

      const c = gradFrom.clone().lerp(gradTo, t);
      colors[idx] = c.r; colors[idx+1] = c.g; colors[idx+2] = c.b;
      positions[idx] = (Math.random()-0.5)*140; positions[idx+1] = (Math.random()-0.5)*140; positions[idx+2] = (Math.random()-0.5)*140;
    }
    treeGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    treeGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    const treeMaterial = new THREE.PointsMaterial({ size: isMobile ? 0.28 : 0.2, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending, vertexColors: true });
    const treePoints = new THREE.Points(treeGeometry, treeMaterial);
    group.add(treePoints);

    // --- ã€è¦–è¦ºé‚„åŸã€‘çµ²å¸¶ Ribbon ---
    const ribbonGroup = new THREE.Group();
    group.add(ribbonGroup);
    function buildRibbon() {
      const curvePts = [];
      for (let i = 0; i <= 200; i++) {
        const tt = i / 200;
        const y = yMin + (yMax - yMin) * tt;
        const r = radiusAtY(y) * 0.92;
        const a = tt * Math.PI * 2 * 7.2;
        curvePts.push(new THREE.Vector3(Math.cos(a)*r, y, Math.sin(a)*r));
      }
      const curve = new THREE.CatmullRomCurve3(curvePts);
      const tube = new THREE.TubeGeometry(curve, 200, 0.15, 8, false);
      const matR = new THREE.MeshStandardMaterial({ color: 0xff4d4d, metalness: 0.5, roughness: 0.3 });
      ribbonGroup.add(new THREE.Mesh(tube, matR));
    }
    buildRibbon();

    // --- ã€è¦–è¦ºé‚„åŸã€‘æ˜Ÿæ˜Ÿ Star ---
    function makeStar() {
      const s = new THREE.Shape();
      for(let i=0; i<10; i++){
        const r = i%2==0 ? 2 : 0.8;
        const a = (i/10)*Math.PI*2 - Math.PI/2;
        if(i==0) s.moveTo(Math.cos(a)*r, Math.sin(a)*r); else s.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      }
      const starGeo = new THREE.ExtrudeGeometry(s, {depth:0.5, bevelEnabled:true, bevelSize:0.1});
      const starMesh = new THREE.Mesh(starGeo, new THREE.MeshStandardMaterial({color:0xffd700, emissive:0xffd700, emissiveIntensity:0.8}));
      starMesh.position.y = yMax + 3; starMesh.scale.set(0.6,0.6,0.6);
      
      const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
      const ctx = canvas.getContext('2d');
      const g = ctx.createRadialGradient(32,32,0,32,32,32); g.addColorStop(0,'rgba(255,215,0,1)'); g.addColorStop(1,'rgba(255,215,0,0)');
      ctx.fillStyle=g; ctx.fillRect(0,0,64,64);
      const halo = new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(canvas), blending:THREE.AdditiveBlending}));
      halo.position.y = yMax + 3; halo.scale.set(10,10,1);
      return {starMesh, halo};
    }
    const starPack = makeStar();
    group.add(starPack.starMesh); group.add(starPack.halo);

    // --- ã€è¦–è¦ºé‚„åŸã€‘è£é£¾å“ ---
    const ornaments = new THREE.InstancedMesh(new THREE.SphereGeometry(0.35,8,8), new THREE.MeshStandardMaterial({color:0xff4d4d}), 30);
    const dummy = new THREE.Object3D();
    for(let i=0; i<30; i++){
      const y = yMin + Math.random()*(yMax-yMin); const r = radiusAtY(y)*0.9; const a = Math.random()*Math.PI*2;
      dummy.position.set(Math.cos(a)*r, y, Math.sin(a)*r); dummy.updateMatrix(); ornaments.setMatrixAt(i, dummy.matrix);
    }
    group.add(ornaments);

    // --- é›ªèŠ± ---
    const snowCount = isMobile ? 600 : 1200;
    const snowGeo = new THREE.BufferGeometry();
    const snowPos = new Float32Array(snowCount * 3);
    for(let i=0; i<snowCount*3; i++) snowPos[i] = (Math.random()-0.5)*140;
    snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
    const snow = new THREE.Points(snowGeo, new THREE.PointsMaterial({color:0xffffff, size:0.3, transparent:true, opacity:0.6}));
    scene.add(snow);

    // --- æ‰‹å‹¢èˆ‡å‹•ç•«é‚è¼¯ ---
    let explodeFactor = 0, targetExplode = 0;
    let filteredY = 0.5;

    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 1, modelComplexity: isMobile ? 0 : 1, minDetectionConfidence: 0.5 });
    hands.onResults((res) => {
      if(res.multiHandLandmarks && res.multiHandLandmarks[0]) {
        const h = res.multiHandLandmarks[0];
        // çˆ†ç‚¸
        const d = Math.hypot(h[4].x-h[20].x, h[4].y-h[20].y);
        targetExplode = Math.max(0, Math.min(1, (d - 0.35) / 0.2));
        // ä½ç§»èˆ‡æ—‹è½‰
        group.position.x += ((0.5 - h[0].x)*40 - group.position.x)*0.1;
        filteredY += (h[9].y - filteredY)*0.1;
        group.rotation.y = (filteredY - 0.5)*Math.PI*2;
      } else {
        targetExplode = 0;
      }
    });

    function animate() {
      requestAnimationFrame(animate);
      explodeFactor += (targetExplode - explodeFactor) * 0.08;
      
      const posArr = treeGeometry.attributes.position.array;
      for(let i=0; i<particleCount; i++){
        const idx = i*3;
        const tx = baseTargets[idx] + (explodedTargets[idx]-baseTargets[idx])*explodeFactor;
        const ty = baseTargets[idx+1] + (explodedTargets[idx+1]-baseTargets[idx+1])*explodeFactor;
        const tz = baseTargets[idx+2] + (explodedTargets[idx+2]-baseTargets[idx+2])*explodeFactor;
        posArr[idx] += (tx - posArr[idx])*0.1; posArr[idx+1] += (ty - posArr[idx+1])*0.1; posArr[idx+2] += (tz - posArr[idx+2])*0.1;
      }
      treeGeometry.attributes.position.needsUpdate = true;

      // é©šå–œå¡ç‰‡
      const card = document.getElementById('reveal-card');
      if(explodeFactor > 0.7) card.classList.add('show'); else if(explodeFactor < 0.3) card.classList.remove('show');

      starPack.starMesh.rotation.y += 0.02;
      snow.position.y -= 0.1; if(snow.position.y < -40) snow.position.y = 40;
      renderer.render(scene, camera);
    }

    // --- UI æ§åˆ¶ ---
    const toggle = document.getElementById('ui-toggle');
    const panel = document.getElementById('ui-panel');
    const closeBtn = document.getElementById('close-ui');

    toggle.onclick = () => { panel.classList.toggle('show'); closeBtn.style.display = panel.classList.contains('show') ? 'block' : 'none'; };
    closeBtn.onclick = () => { panel.classList.remove('show'); closeBtn.style.display = 'none'; };

    document.getElementById('start-btn').onclick = () => {
      document.getElementById('status').style.display='none';
      const bgm = document.getElementById('bgm'); bgm.play().catch(()=>{});
      const cam = new Camera(document.getElementById('video-preview'), {
        onFrame: async () => { await hands.send({image: document.getElementById('video-preview')}); },
        width: 320, height: 240
      });
      cam.start();
      animate();
    };

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
