<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åå­¸é™¢ï½œAI è–èª•æ¨¹äº’å‹•ï¼ˆRWD å„ªåŒ–ç‰ˆï¼‰</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Corinthia:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', -apple-system, sans-serif; }
    #canvas-container { position: fixed; inset: 0; z-index: 1; }

    /* åˆå§‹ç‹€æ…‹å±¤ */
    #status {
      position: fixed; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: #fff; z-index: 100;
      background: rgba(0,0,0,0.85);
      text-align: center;
      padding: 24px;
      backdrop-filter: blur(10px);
    }
    #status h1 { margin: 0 0 12px 0; font-size: 24px; color: #22ff88; }
    #status p { margin: 0; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.8; }
    #start-btn {
      margin-top: 24px; padding: 14px 32px; border-radius: 999px;
      border: 0; cursor: pointer; font-weight: 800; font-size: 16px;
      background: #22ff88; color: #00150a;
      box-shadow: 0 0 25px rgba(34,255,136,.4);
    }

    /* æ”å½±æ©Ÿé è¦½ - æ‰‹æ©Ÿç‰ˆç¸®å°ä¸¦ç§»è‡³å³ä¸Šæˆ–è§’è½ */
    #video-preview {
      position: fixed; left: 12px; bottom: 12px;
      width: 120px; height: 90px;
      border-radius: 10px;
      transform: scaleX(-1);
      border: 1.5px solid rgba(255,255,255,0.3);
      z-index: 5;
      object-fit: cover;
      background: #000;
      opacity: 0.7;
    }

    /* å·¨å¤§æ¨™é¡Œï¼šRWD å„ªåŒ– */
    #big-title {
      position: fixed;
      top: 5vh;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      pointer-events: none;
      white-space: nowrap;
      font-family: "Corinthia", cursive;
      font-weight: 700;
      color: #ffffff;
      font-size: clamp(48px, 15vw, 120px); /* ç¸®å°æ‰‹æ©Ÿç«¯å°ºå¯¸ */
      text-shadow: 0 0 15px rgba(255, 60, 60, 0.8), 0 0 10px rgba(255, 215, 0, 0.6);
    }

    #text-layer {
      position: fixed;
      top: clamp(15vh, 20vw, 180px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 9;
      width: 90vw;
      text-align: center;
      pointer-events: none;
    }
    #text-layer .subline { font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
    #text-layer .cta { font-size: 12px; color: #22ff88; font-weight: bold; }

    /* äº’å‹•é©šå–œå¡ç‰‡ */
    #reveal-card {
      position: fixed;
      left: 50%; top: 50%;
      transform: translate(-50%, -40%) scale(0.8);
      width: min(85vw, 340px);
      background: rgba(15,15,25,0.85);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      padding: 12px;
      z-index: 50;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(15px);
    }
    #reveal-card.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
    #reveal-card img { width: 100%; border-radius: 14px; }
    #reveal-card .reveal-text { margin-top: 10px; font-size: 13px; color: #fff; text-align: center; }

    /* âœ… æ”¶åˆå¼ UI Panel */
    #ui-panel {
      position: fixed; top: 12px; right: 12px;
      width: 260px; 
      background: rgba(20,20,35,0.9);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.15);
      color: #fff; z-index: 60;
      transition: transform 0.3s ease;
      max-height: 85vh;
      overflow-y: auto;
    }
    /* æ‰‹æ©Ÿç‰ˆé è¨­æ”¶èµ· */
    @media (max-width: 600px) {
      #ui-panel { transform: translateX(calc(100% + 20px)); width: 240px; }
      #ui-panel.open { transform: translateX(0); }
    }

    #ui-toggle {
      position: fixed; top: 12px; right: 12px;
      width: 44px; height: 44px;
      background: #22ff88; color: #000;
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 61; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .panel-content { padding: 16px; }
    .panel-content h2 { margin: 0 0 12px 0; font-size: 15px; display: flex; align-items: center; gap: 8px; }
    .help { font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 8px; }

    .color-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .cbtn {
      width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff; cursor: pointer;
    }

    .toggle-row { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .toggle-row label { font-size: 12px; }

    .switch {
      width: 40px; height: 20px; background: rgba(255,255,255,0.2);
      border-radius: 20px; position: relative; cursor: pointer;
    }
    .knob {
      width: 14px; height: 14px; background: #fff; border-radius: 50%;
      position: absolute; top: 3px; left: 3px; transition: 0.2s;
    }
    .switch.on { background: #22ff88; }
    .switch.on .knob { left: 23px; }

    #audio-btn {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; font-size: 12px;
    }

    .sparkle {
      position: fixed; width: 30px; height: 30px;
      background: radial-gradient(circle, #fff 10%, #ffd700 40%, transparent 70%);
      border-radius: 50%; pointer-events: none; z-index: 99;
      animation: flash 0.5s ease-out forwards;
    }
    @keyframes flash { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

    /* æ‰‹æ©Ÿå°ˆç”¨é—œé–‰æŒ‰éˆ• */
    #close-panel {
      display: none; text-align: center; padding: 10px; color: #22ff88; font-size: 12px; font-weight: bold;
    }
    @media (max-width: 600px) { #close-panel { display: block; border-top: 1px solid rgba(255,255,255,0.1); } }
  </style>
</head>
<body>

  <div id="status">
    <h1>ğŸ„ åå­¸é™¢ AI è–èª•é©šå–œ</h1>
    <p>
      è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™ä»¥é€²è¡Œäº’å‹•ï¼š<br/><br/>
      ğŸ– <b>å¼µé–‹æ‰‹æŒ</b>ï¼šè§£é–é©šå–œ<br/>
      ğŸ‘‹ <b>å·¦å³æ®å‹•</b>ï¼šç§»å‹•æ¨¹æœ¨<br/>
      ğŸ‘Œ <b>é£ŸæŒ‡æåˆ</b>ï¼šé‡‹æ”¾é­”æ³•
    </p>
    <button id="start-btn">é€²å…¥è–èª•ä¸–ç•Œ</button>
  </div>

  <video id="video-preview" playsinline></video>

  <div id="big-title">Merry Christmas</div>

  <div id="text-layer">
    <div class="subline">æ‰‹æŒã€Œå¤§å¼µé–‹ã€è§£é–éš±è—ç¦®ç‰©</div>
    <div class="cta">åå­¸é™¢ï½œAI x è·æ¶¯æ¢ç´¢</div>
  </div>

  <div id="reveal-card">
    <img id="reveal-img" src="https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=800&auto=format&fit=crop" alt="Surprise" />
    <div class="reveal-text">âœ¨ æ­å–œè§£é–è–èª•é©šå–œ âœ¨<br/>é¡˜ AI å¸¶çµ¦ä½ ç„¡é™å¯èƒ½ï¼</div>
  </div>

  <audio id="bgm" src="https://www.chosic.com/wp-content/uploads/2021/11/Jingle-Bells-3.mp3" loop preload="auto"></audio>

  <div id="ui-toggle">âš™ï¸</div>

  <div id="ui-panel">
    <div class="panel-content">
      <h2>âœ¨ æ§åˆ¶å°</h2>
      <div class="help">æ›´æ›è–èª•æ¨¹è‰²èª¿ï¼š</div>
      <div class="color-row">
        <div class="cbtn" style="background:#22ff88" data-c="#22ff88"></div>
        <div class="cbtn" style="background:#ff4d4d" data-c="#ff4d4d"></div>
        <div class="cbtn" style="background:#ffd700" data-c="#ffd700"></div>
        <div class="cbtn" style="background:#ffffff" data-c="#ffffff"></div>
        <div class="cbtn" style="background:#6dd5ff" data-c="#6dd5ff"></div>
      </div>

      <div class="toggle-row">
        <label>æ¼¸å±¤æ¨¡å¼</label>
        <div id="gradSwitch" class="switch on"><div class="knob"></div></div>
      </div>

      <button id="audio-btn">ğŸ”Š éŸ³æ¨‚æ’­æ”¾ä¸­</button>
    </div>
    <div id="close-panel">ç¢ºèªä¸¦è¿”å›</div>
  </div>

  <div id="canvas-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <script>
    // --- UI äº¤äº’é‚è¼¯ ---
    const uiToggle = document.getElementById('ui-toggle');
    const uiPanel = document.getElementById('ui-panel');
    const closePanel = document.getElementById('close-panel');

    uiToggle.onclick = () => {
      uiPanel.classList.toggle('open');
      uiToggle.style.display = uiPanel.classList.contains('open') ? 'none' : 'flex';
    };
    closePanel.onclick = () => {
      uiPanel.classList.remove('open');
      uiToggle.style.display = 'flex';
    };

    // --- Three.js åˆå§‹åŒ– ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x000000, 30, 100);

    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    camera.position.set(0, 5, 55);

    const group = new THREE.Group();
    scene.add(group);

    // å…‰æº
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const pLight = new THREE.PointLight(0xffffff, 1);
    pLight.position.set(0, 20, 20);
    scene.add(pLight);

    const isMobile = window.innerWidth < 600;

    // --- è–èª•æ¨¹ç²’å­ ---
    const particleCount = isMobile ? 6000 : 12000;
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    const base = new Float32Array(particleCount * 3);
    const expo = new Float32Array(particleCount * 3);

    const treeH = 35;
    const gradFrom = new THREE.Color(0x22ff88);
    const gradTo = new THREE.Color(0xffd700);

    for(let i=0; i<particleCount; i++){
      const idx = i * 3;
      const t = Math.random();
      const y = (t - 0.5) * treeH;
      const r = (1 - t) * 15 + 0.5;
      const angle = t * Math.PI * 18 + Math.random() * 0.5;

      const x = Math.cos(angle) * r;
      const z = Math.sin(angle) * r;

      base[idx] = x; base[idx+1] = y; base[idx+2] = z;
      pos[idx] = (Math.random()-0.5)*100; pos[idx+1] = (Math.random()-0.5)*100; pos[idx+2] = (Math.random()-0.5)*100;

      const dir = new THREE.Vector3(x, y*0.2, z).normalize();
      expo[idx] = x + dir.x * 40; expo[idx+1] = y + dir.y * 40; expo[idx+2] = z + dir.z * 40;

      const c = gradFrom.clone().lerp(gradTo, t);
      colors[idx] = c.r; colors[idx+1] = c.g; colors[idx+2] = c.b;
    }
    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    const mat = new THREE.PointsMaterial({ size: isMobile?0.3:0.2, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.8 });
    const points = new THREE.Points(geo, mat);
    group.add(points);

    // --- é›ªèŠ± ---
    const snowGeo = new THREE.BufferGeometry();
    const snowPos = new Float32Array(isMobile?500:1000 * 3);
    for(let i=0; i<snowPos.length; i++) snowPos[i] = (Math.random()-0.5)*150;
    snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
    const snowMat = new THREE.PointsMaterial({ size: 0.3, color: 0xffffff, transparent: true, opacity: 0.6 });
    const snow = new THREE.Points(snowGeo, snowMat);
    scene.add(snow);

    // --- æ‰‹å‹¢è™•ç† ---
    let explode = 0;
    let targetExplode = 0;
    const videoElement = document.getElementById('video-preview');

    function onResults(results) {
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const hand = results.multiHandLandmarks[0];
        // çˆ†ç‚¸åˆ¤æ–· (å¤§æ‹‡æŒ‡èˆ‡å°æ‹‡æŒ‡è·é›¢)
        const d = Math.hypot(hand[4].x - hand[20].x, hand[4].y - hand[20].y);
        targetExplode = THREE.MathUtils.mapLinear(d, 0.3, 0.6, 0, 1);
        targetExplode = Math.max(0, Math.min(1, targetExplode));

        // å·¦å³ç§»å‹•
        const tx = (0.5 - hand[0].x) * 60;
        group.position.x += (tx - group.position.x) * 0.1;
        
        // æ—‹è½‰
        group.rotation.y += 0.01;
      } else {
        targetExplode = 0;
      }
    }

    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
    hands.onResults(onResults);

    // --- å‹•ç•«å¾ªç’° ---
    function animate() {
      requestAnimationFrame(animate);
      explode += (targetExplode - explode) * 0.1;
      
      const p = geo.attributes.position.array;
      for(let i=0; i<particleCount; i++){
        const idx = i*3;
        p[idx] += ( (base[idx] + (expo[idx]-base[idx])*explode) - p[idx] ) * 0.1;
        p[idx+1] += ( (base[idx+1] + (expo[idx+1]-base[idx+1])*explode) - p[idx+1] ) * 0.1;
        p[idx+2] += ( (base[idx+2] + (expo[idx+2]-base[idx+2])*explode) - p[idx+2] ) * 0.1;
      }
      geo.attributes.position.needsUpdate = true;

      // é©šå–œå¡ç‰‡é¡¯ç¤º
      if(explode > 0.8) document.getElementById('reveal-card').classList.add('show');
      else if(explode < 0.3) document.getElementById('reveal-card').classList.remove('show');

      snow.position.y -= 0.05;
      if(snow.position.y < -50) snow.position.y = 50;

      renderer.render(scene, camera);
    }

    // --- äº‹ä»¶ç¶å®š ---
    document.getElementById('start-btn').onclick = () => {
      document.getElementById('status').style.display = 'none';
      const bgm = document.getElementById('bgm');
      bgm.play().catch(()=>{});
      
      const cameraSetup = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 320, height: 240
      });
      cameraSetup.start();
      animate();
    };

    // é¡è‰²åˆ‡æ›
    document.querySelectorAll('.cbtn').forEach(b => {
      b.onclick = () => {
        mat.vertexColors = false;
        mat.color.set(b.dataset.c);
        document.getElementById('gradSwitch').classList.remove('on');
      };
    });

    document.getElementById('gradSwitch').onclick = function() {
      this.classList.toggle('on');
      mat.vertexColors = this.classList.contains('on');
      mat.needsUpdate = true;
    };

    window.onresize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
  </script>
</body>
</html>
